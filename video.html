<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editor Video + Logo M칩vil</title>
<style>
body { font-family:sans-serif; text-align:center; margin:0; padding:20px; background:#f9f9f9; }
input, button { display:block; width:90%; max-width:320px; margin:10px auto; padding:12px; font-size:1rem; border-radius:8px; border:1px solid #ccc; }
button { background:#0077ff; color:white; font-weight:bold; border:none; }
canvas { margin:20px auto; max-width:100%; border:2px dashed #666; touch-action:none; background:#000; }
video { margin-top:20px; max-width:90%; border:1px solid #333; display:none; }
</style>
</head>
<body>
<h1>Editor Video + Logo M칩vil</h1>
<input type="file" id="videoInput" accept="video/*">
<input type="file" id="logoInput" accept="image/png">
<button id="exportBtn">游꿟 Exportar MP4</button>
<canvas id="canvas"></canvas>
<video id="resultVideo" controls></video>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const resultVideo = document.getElementById('resultVideo');
const WIDTH=1080, HEIGHT=1350;
canvas.width=WIDTH; canvas.height=HEIGHT;

let video=null, logo=null;
let logoX=WIDTH-270, logoY=HEIGHT-270, logoW=250, logoH=250;
let dragging=false, dragTarget=null, startX=0, startY=0, lastDist=null;

// Dibujo canvas
function draw(){
  ctx.fillStyle="#000"; ctx.fillRect(0,0,WIDTH,HEIGHT);
  if(video && video.readyState>=2){
    let vRatio=video.videoWidth/video.videoHeight, cRatio=WIDTH/HEIGHT;
    let drawW=WIDTH, drawH=HEIGHT;
    if(vRatio>cRatio){ drawH=HEIGHT; drawW=HEIGHT*vRatio; }
    else{ drawW=WIDTH; drawH=WIDTH/vRatio; }
    ctx.drawImage(video,(WIDTH-drawW)/2,(HEIGHT-drawH)/2,drawW,drawH);
  }
  if(logo) ctx.drawImage(logo,logoX,logoY,logoW,logoH);
}
function loop(){ draw(); requestAnimationFrame(loop); }
loop();

// Cargar video
document.getElementById('videoInput').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const url = URL.createObjectURL(file);
  video=document.createElement('video');
  video.src=url; video.loop=true; video.muted=false; video.play();
});

// Cargar logo
document.getElementById('logoInput').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    logo = new Image();
    logo.onload = ()=>{ logoW=250; logoH=logoW*(logo.height/logo.width); logoX=WIDTH-logoW-20; logoY=HEIGHT-logoH-20; };
    logo.src = ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Gestos t치ctiles
canvas.addEventListener('touchstart', e=>{
  const rect=canvas.getBoundingClientRect();
  const x=(e.touches[0].clientX-rect.left)*(WIDTH/rect.width);
  const y=(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height);
  if(e.touches.length===1){
    if(logo && x>=logoX && x<=logoX+logoW && y>=logoY && y<=logoY+logoH) dragTarget="logo";
    else dragTarget=null;
    dragging=true; startX=x; startY=y;
  } else if(e.touches.length===2){
    const p1={x:(e.touches[0].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height)};
    const p2={x:(e.touches[1].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[1].clientY-rect.top)*(HEIGHT/rect.height)};
    if([p1,p2].every(p=>p.x>=logoX && p.x<=logoX+logoW && p.y>=logoY && p.y<=logoY+logoH)) dragTarget="logo";
    else dragTarget=null;
    lastDist=Math.hypot(p1.x-p2.x,p1.y-p2.y);
  }
});
canvas.addEventListener('touchmove', e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const x=(e.touches[0].clientX-rect.left)*(WIDTH/rect.width);
  const y=(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height);
  if(e.touches.length===1 && dragging && dragTarget==="logo"){
    logoX+=x-startX; logoY+=y-startY; startX=x; startY=y;
  } else if(e.touches.length===2 && lastDist && dragTarget==="logo"){
    const p1={x:(e.touches[0].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height)};
    const p2={x:(e.touches[1].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[1].clientY-rect.top)*(HEIGHT/rect.height)};
    const dist=Math.hypot(p1.x-p2.x,p1.y-p2.y);
    const zoom=dist/lastDist;
    const cx=logoX+logoW/2, cy=logoY+logoH/2;
    logoW*=zoom; logoH=logoW*(logo.height/logo.width);
    logoX=cx-logoW/2; logoY=cy-logoH/2;
    lastDist=dist;
  }
});
canvas.addEventListener('touchend', e=>{ if(e.touches.length===0) dragging=false; if(e.touches.length<2) lastDist=null; });

// Exportar MP4 usando ffmpeg.wasm
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  if(!video) return alert("Sub칤 un video primero.");
  alert("Cargando ffmpeg... puede tardar unos segundos la primera vez.");
  if(!ffmpeg.isLoaded()) await ffmpeg.load();

  // Grab canvas frames
  const stream = canvas.captureStream(30);
  const audioTracks = video.captureStream().getAudioTracks();
  audioTracks.forEach(t=>stream.addTrack(t));

  const mediaRecorder = new MediaRecorder(stream,{mimeType:'video/webm'});
  const chunks=[];
  mediaRecorder.ondataavailable = e=>chunks.push(e.data);

  mediaRecorder.onstop = async ()=>{
    const webmBlob = new Blob(chunks,{type:'video/webm'});
    ffmpeg.FS('writeFile','input.webm',await fetchFile(webmBlob));
    await ffmpeg.run('-i','input.webm','-c:v','libx264','-c:a','aac','output.mp4');
    const data = ffmpeg.FS('readFile','output.mp4');
    const mp4Blob = new Blob([data.buffer],{type:'video/mp4'});
    const url = URL.createObjectURL(mp4Blob);
    resultVideo.src = url;
    resultVideo.style.display='block';

    const a=document.createElement('a');
    a.href=url; a.download='video_final.mp4'; a.click();
  };

  mediaRecorder.start();
  alert("Grabando video completo... cierra este mensaje y espera la exportaci칩n.");
  video.onended = ()=>mediaRecorder.stop();
});
</script>
</body>
</html>
