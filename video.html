<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editor Video + Logo M칩vil</title>
<style>
body { font-family:sans-serif; text-align:center; margin:0; padding:20px; background:#f9f9f9; }
h1 { font-size:1.4rem; margin-bottom:1rem; }
input, button { display:block; width:90%; max-width:320px; margin:10px auto; padding:12px; font-size:1rem; border-radius:8px; border:1px solid #ccc; }
button { background:#0077ff; color:white; font-weight:bold; border:none; }
button:active { background:#005fcc; }
#editorCanvas { margin:20px auto; max-width:100%; border:2px dashed #666; touch-action:none; background:#000; }
#exportedVideo { margin-top:20px; max-width:90%; border:1px solid #333; display:none; }
</style>
</head>
<body>
<h1>Editor Video + Logo M칩vil</h1>

<input type="file" id="videoInput" accept="video/*">
<input type="file" id="logoInput" accept="image/png">
<button id="startRecordBtn">游꿟 Exportar Video</button>

<canvas id="editorCanvas"></canvas>
<video id="exportedVideo" controls></video>
<button id="shareBtn" style="display:none;">游 Guardar / Compartir Video</button>

<script>
const canvas = document.getElementById("editorCanvas");
const ctx = canvas.getContext("2d");
const exportedVideo = document.getElementById("exportedVideo");
const shareBtn = document.getElementById("shareBtn");
const WIDTH = 1080, HEIGHT = 1350;
canvas.width = WIDTH; canvas.height = HEIGHT;

let video=null, logo=null;
let logoX=WIDTH-270, logoY=HEIGHT-270, logoW=250, logoH=250;
let dragging=false, dragTarget=null, startX=0, startY=0, lastDist=null;

// Dibujo canvas
function draw(){
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,WIDTH,HEIGHT);
  if(video && video.readyState>=2){
    let vRatio=video.videoWidth/video.videoHeight;
    let cRatio=WIDTH/HEIGHT;
    let drawW=WIDTH, drawH=HEIGHT;
    if(vRatio>cRatio){ drawH=HEIGHT; drawW=HEIGHT*vRatio; }
    else{ drawW=WIDTH; drawH=WIDTH/vRatio; }
    ctx.drawImage(video,(WIDTH-drawW)/2,(HEIGHT-drawH)/2,drawW,drawH);
  }
  if(logo) ctx.drawImage(logo,logoX,logoY,logoW,logoH);
}
function loop(){ draw(); requestAnimationFrame(loop); }

// Cargar video
document.getElementById("videoInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const url=URL.createObjectURL(file);
  video=document.createElement("video");
  video.src=url; video.loop=true; video.muted=false; video.play();
});

// Cargar logo
document.getElementById("logoInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    logo=new Image();
    logo.onload=()=>{ logoW=250; logoH=logoW*(logo.height/logo.width); logoX=WIDTH-logoW-20; logoY=HEIGHT-logoH-20; };
    logo.src=ev.target.result;
  };
  reader.readAsDataURL(file);
});

// Gestos t치ctiles
canvas.addEventListener("touchstart", e=>{
  const rect=canvas.getBoundingClientRect();
  const x=(e.touches[0].clientX-rect.left)*(WIDTH/rect.width);
  const y=(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height);
  if(e.touches.length===1){
    if(logo && x>=logoX && x<=logoX+logoW && y>=logoY && y<=logoY+logoH) dragTarget="logo";
    else dragTarget=null;
    dragging=true; startX=x; startY=y;
  } else if(e.touches.length===2){
    const p1={x:(e.touches[0].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height)};
    const p2={x:(e.touches[1].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[1].clientY-rect.top)*(HEIGHT/rect.height)};
    if([p1,p2].every(p=>p.x>=logoX && p.x<=logoX+logoW && p.y>=logoY && p.y<=logoY+logoH)) dragTarget="logo";
    else dragTarget=null;
    lastDist=Math.hypot(p1.x-p2.x,p1.y-p2.y);
  }
});

canvas.addEventListener("touchmove", e=>{
  e.preventDefault();
  const rect=canvas.getBoundingClientRect();
  const x=(e.touches[0].clientX-rect.left)*(WIDTH/rect.width);
  const y=(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height);
  if(e.touches.length===1 && dragging && dragTarget==="logo"){
    logoX+=x-startX; logoY+=y-startY; startX=x; startY=y;
  } else if(e.touches.length===2 && lastDist && dragTarget==="logo"){
    const p1={x:(e.touches[0].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height)};
    const p2={x:(e.touches[1].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[1].clientY-rect.top)*(HEIGHT/rect.height)};
    const dist=Math.hypot(p1.x-p2.x,p1.y-p2.y);
    const zoom=dist/lastDist;
    const cx=logoX+logoW/2, cy=logoY+logoH/2;
    logoW*=zoom; logoH=logoW*(logo.height/logo.width);
    logoX=cx-logoW/2; logoY=cy-logoH/2;
    lastDist=dist;
  }
});

canvas.addEventListener("touchend", e=>{ if(e.touches.length===0) dragging=false; if(e.touches.length<2) lastDist=null; });

loop();

// Exportar WebM con audio
let recordedBlob = null;
document.getElementById("startRecordBtn").addEventListener("click", ()=>{
  if(!video) return alert("Sub칤 un video primero.");

  const canvasStream = canvas.captureStream(30);
  const audioTracks = video.captureStream().getAudioTracks();
  audioTracks.forEach(t=>canvasStream.addTrack(t));

  const mediaRecorder = new MediaRecorder(canvasStream,{mimeType:"video/webm"});
  const chunks=[];
  mediaRecorder.ondataavailable = e=>chunks.push(e.data);
  mediaRecorder.onstop = ()=>{
    recordedBlob = new Blob(chunks,{type:"video/webm"});
    const url = URL.createObjectURL(recordedBlob);
    exportedVideo.src=url;
    exportedVideo.style.display="block";
    shareBtn.style.display="block";
    alert("Video listo. Usa el bot칩n 'Guardar / Compartir' para almacenarlo en tu dispositivo o enviarlo a otra app.");
  };

  mediaRecorder.start();
  alert("Grabando video completo... cierra este mensaje y espera a que termine la exportaci칩n.");
  video.onended = ()=>mediaRecorder.stop();
});

// Guardar / Compartir
shareBtn.addEventListener("click", async ()=>{
  if(!recordedBlob) return;
  const file = new File([recordedBlob], "video_con_logo.webm", {type:"video/webm"});
  if(navigator.canShare && navigator.canShare({ files:[file] })){
    try{ await navigator.share({ files:[file], title:"Video con Logo", text:"Aqu칤 est치 el video"}); }
    catch(err){ alert("Compartir cancelado o no soportado."); }
  } else {
    alert("En este dispositivo, no se puede descargar autom치ticamente. Mant칠n presionado el video y selecciona 'Guardar video' para almacenarlo.");
  }
});
</script>
</body>
</html>
