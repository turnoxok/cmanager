<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editor Video + Logo MP4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.2/dist/ffmpeg.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align:center; margin:0; padding:20px; background:#f9f9f9; }
    h1 { font-size:1.4rem; margin-bottom:1rem; }
    input, button { display:block; width:100%; max-width:320px; margin:10px auto; padding:12px; font-size:1rem; border-radius:8px; border:1px solid #ccc; }
    button { background:#0077ff; color:white; font-weight:bold; border:none; }
    button:active { background:#005fcc; }
    #editorCanvas { margin:20px auto; max-width:100%; border:2px dashed #666; touch-action:none; background:#000; }
  </style>
</head>
<body>
  <h1>Editor Video + Logo MP4</h1>

  <input type="file" id="videoInput" accept="video/*">
  <input type="file" id="logoInput" accept="image/png">
  <button id="startRecordBtn">üé¨ Exportar MP4</button>

  <canvas id="editorCanvas"></canvas>

  <script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    const editorCanvas = document.getElementById("editorCanvas");
    const ctx = editorCanvas.getContext("2d");
    const WIDTH = 1080, HEIGHT = 1350;
    editorCanvas.width = WIDTH;
    editorCanvas.height = HEIGHT;

    let video=null, logoImg=null;
    let logoX = WIDTH - 270, logoY = HEIGHT - 270, logoW = 250, logoH = 250;
    let dragging=false, dragTarget=null, startX=0, startY=0, lastDist=null;

    function drawEditor(){
      ctx.fillStyle="#000";
      ctx.fillRect(0,0,WIDTH,HEIGHT);
      if(video && video.readyState>=2){
        let videoRatio = video.videoWidth/video.videoHeight;
        let canvasRatio = WIDTH/HEIGHT;
        let drawW=WIDTH, drawH=HEIGHT;
        if(videoRatio>canvasRatio){ drawH=HEIGHT; drawW=HEIGHT*videoRatio; }
        else{ drawW=WIDTH; drawH=WIDTH/videoRatio; }
        ctx.drawImage(video,(WIDTH-drawW)/2,(HEIGHT-drawH)/2,drawW,drawH);
      }
      if(logoImg) ctx.drawImage(logoImg,logoX,logoY,logoW,logoH);
    }

    function loop(){ drawEditor(); requestAnimationFrame(loop); }

    document.getElementById("videoInput").addEventListener("change", e=>{
      const file = e.target.files[0]; if(!file) return;
      const url = URL.createObjectURL(file);
      video = document.createElement("video");
      video.src=url; video.loop=true; video.muted=false; video.play();
    });

    document.getElementById("logoInput").addEventListener("change", e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ev=>{
        logoImg = new Image();
        logoImg.onload=()=>{
          logoW=250; logoH=logoW*(logoImg.height/logoImg.width);
          logoX = WIDTH - logoW - 20; logoY = HEIGHT - logoH - 20;
        };
        logoImg.src=ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Gestos
    editorCanvas.addEventListener("touchstart", e=>{
      const rect = editorCanvas.getBoundingClientRect();
      const x = (e.touches[0].clientX-rect.left)*(WIDTH/rect.width);
      const y = (e.touches[0].clientY-rect.top)*(HEIGHT/rect.height);
      if(e.touches.length===1){
        if(logoImg && x>=logoX && x<=logoX+logoW && y>=logoY && y<=logoY+logoH) dragTarget="logo";
        else dragTarget=null;
        dragging=true; startX=x; startY=y;
      } else if(e.touches.length===2){
        const p1={x:(e.touches[0].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[0].clientY-rect.top)*(HEIGHT/rect.height)};
        const p2={x:(e.touches[1].clientX-rect.left)*(WIDTH/rect.width), y:(e.touches[1].clientY-rect.top)*(HEIGHT/rect.height)};
        if([p1,p2].every(p=>p.x>=logoX && p.x<=logoX+logoW && p.y>=logoY && p.y<=logoY+logoH)) dragTarget="logo";
        else dragTarget=null;
        lastDist=getDist(e.touches);
      }
    });

    editorCanvas.addEventListener("touchmove", e=>{
      e.preventDefault();
      const rect = editorCanvas.getBoundingClientRect();
      const x = (e.touches[0].clientX-rect.left)*(WIDTH/rect.width);
      const y = (e.touches[0].clientY-rect.top)*(HEIGHT/rect.height);
      if(e.touches.length===1 && dragging && dragTarget==="logo"){
        const dx=x-startX, dy=y-startY;
        logoX+=dx; logoY+=dy; startX=x; startY=y;
      } else if(e.touches.length===2 && lastDist && dragTarget==="logo"){
        const dist=getDist(e.touches);
        const zoom = dist/lastDist;
        const centerX=logoX+logoW/2, centerY=logoY+logoH/2;
        logoW*=zoom; logoH=logoW*(logoImg.height/logoImg.width);
        logoX=centerX-logoW/2; logoY=centerY-logoH/2;
        lastDist=dist;
      }
    });

    editorCanvas.addEventListener("touchend", e=>{
      if(e.touches.length===0) dragging=false;
      if(e.touches.length<2) lastDist=null;
    });

    function getDist(touches){ const dx=touches[0].clientX-touches[1].clientX; const dy=touches[0].clientY-touches[1].clientY; return Math.sqrt(dx*dx+dy*dy); }

    loop();

    // ---------------- Exportar MP4 ----------------
    document.getElementById("startRecordBtn").addEventListener("click", async ()=>{
      if(!video) return alert("Sub√≠ un video primero.");
      alert("Esto puede tardar un poco dependiendo del video. Esper√° a que termine la exportaci√≥n.");

      await ffmpeg.load();

      // 1. Capturar frames del canvas y guardarlos como PNG
      const frames = [];
      const fps = 30;
      const totalFrames = Math.floor(video.duration * fps);
      const offCanvas = document.createElement("canvas");
      offCanvas.width = WIDTH; offCanvas.height = HEIGHT;
      const offCtx = offCanvas.getContext("2d");

      for(let i=0; i<totalFrames; i++){
        video.currentTime = i/fps;
        await new Promise(r=>video.onseeked=r);
        offCtx.fillStyle="#000";
        offCtx.fillRect(0,0,WIDTH,HEIGHT);
        let videoRatio = video.videoWidth/video.videoHeight;
        let canvasRatio = WIDTH/HEIGHT;
        let drawW=WIDTH, drawH=HEIGHT;
        if(videoRatio>canvasRatio){ drawH=HEIGHT; drawW=HEIGHT*videoRatio; }
        else{ drawW=WIDTH; drawH=WIDTH/videoRatio; }
        offCtx.drawImage(video,(WIDTH-drawW)/2,(HEIGHT-drawH)/2,drawW,drawH);
        if(logoImg) offCtx.drawImage(logoImg,logoX,logoY,logoW,logoH);

        const dataURL = offCanvas.toDataURL("image/png");
        frames.push(dataURL);
      }

      // 2. Guardar frames en ffmpeg FS
      for(let i=0;i<frames.length;i++){
        const res = await fetch(frames[i]);
        const buf = await res.arrayBuffer();
        ffmpeg.FS('writeFile', `frame${i.toString().padStart(4,'0')}.png`, new Uint8Array(buf));
      }

      // 3. Guardar audio original en ffmpeg FS
      const videoFile = await fetchFile(video.src);
      ffmpeg.FS('writeFile','audio.mp4',videoFile);

      // 4. Renderizar video MP4 con ffmpeg
      await ffmpeg.run('-r', fps.toString(), '-i', 'frame%04d.png', '-i','audio.mp4','-c:v','libx264','-c:a','aac','-pix_fmt','yuv420p','video_final.mp4');

      // 5. Descargar
      const data = ffmpeg.FS('readFile','video_final.mp4');
      const url = URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
      const a = document.createElement('a');
      a.href=url; a.download='video_final_con_logo.mp4'; a.click();
    });
  </script>
</body>
</html>
