<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Editor Video Instagram 1080x1350</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #f5f5f5;
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    touch-action: pan-y;
  }
  h1 {
    margin-bottom: 20px;
  }
  input[type="file"], button {
    margin: 10px 0;
    padding: 12px 20px;
    border-radius: 12px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  input[type="file"] {
    background-color: #1e1e1e;
    color: #f5f5f5;
  }
  input[type="file"]::file-selector-button {
    background-color: #4CAF50;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 6px 12px;
    font-weight: bold;
    cursor: pointer;
  }
  input[type="file"]::file-selector-button:hover {
    background-color: #45a049;
  }
  button {
    background: linear-gradient(135deg,#4CAF50,#2E8B57);
    color: white;
    font-size: 16px;
    transition: 0.2s;
  }
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  }
  #editorCanvas {
    border: 2px solid #444;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    max-width: 100%;
    touch-action: none;
    margin: 20px 0;
  }
  #progressBar {
    width: 80%;
    max-width: 600px;
    height: 20px;
    border-radius: 12px;
    overflow: hidden;
    appearance: none;
    background-color: #333;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    margin-top: 20px;
  }
  #progressBar::-webkit-progress-value {
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
  }
  #progressBar::-moz-progress-bar {
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
  }
</style>
</head>
<body>
<h1>Editor Video Instagram 1080x1350</h1>

<input type="file" id="videoInput" accept="video/*"><br>
<input type="file" id="logoInput" accept="image/png"><br>

<canvas id="editorCanvas"></canvas><br>

<button id="exportBtn">Exportar Video</button>
<progress id="progressBar" value="0" max="100"></progress>

<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.8/dist/ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

const canvas = document.getElementById("editorCanvas");
const ctx = canvas.getContext("2d");

let video = null, logo = null;
let videoX = 0, videoY = 0, videoW = 0, videoH = 0;
let logoX = 0, logoY = 0, logoW = 100, logoH = 100;

let dragging = false, dragTarget = null, startX = 0, startY = 0, lastDist = null;

// --- dibujar canvas ---
function drawEditor() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (video && video.readyState >= 2) ctx.drawImage(video, videoX, videoY, videoW, videoH);
  if (logo) ctx.drawImage(logo, logoX, logoY, logoW, logoH);
  requestAnimationFrame(drawEditor);
}
drawEditor();

// --- carga video ---
document.getElementById("videoInput").addEventListener("change", e=>{
  const file = e.target.files[0]; if(!file) return;
  video = document.createElement("video");
  video.src = URL.createObjectURL(file);
  video.loop = true; video.muted = true; video.play();
  video.addEventListener("loadedmetadata", ()=>{
    const ratio = video.videoWidth / video.videoHeight;
    const targetH = 1350;
    const targetW = targetH * ratio;
    videoW = targetW; videoH = targetH;
    canvas.width = 1080;
    canvas.height = 1350;
    videoX = (canvas.width - videoW)/2;
    videoY = (canvas.height - videoH)/2;
    logoX = canvas.width - logoW - 20;
    logoY = canvas.height - logoH - 20;
  });
});

// --- carga logo ---
document.getElementById("logoInput").addEventListener("change", e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    logo = new Image();
    logo.src = ev.target.result;
    logo.onload = ()=>{
      logoW = Math.min(200, logo.width);
      logoH = logoW * (logo.height/logo.width);
      logoX = canvas.width - logoW - 20;
      logoY = canvas.height - logoH - 20;
    }
  };
  reader.readAsDataURL(file);
});

// --- drag & pinch ---
function getPos(e){
  const rect = canvas.getBoundingClientRect();
  if(e.touches){
    return [
      (e.touches[0].clientX-rect.left)*(canvas.width/rect.width),
      (e.touches[0].clientY-rect.top)*(canvas.height/rect.height)
    ];
  } else {
    return [
      (e.clientX-rect.left)*(canvas.width/rect.width),
      (e.clientY-rect.top)*(canvas.height/rect.height)
    ];
  }
}

function startDrag(e){
  const [x,y]=getPos(e);
  if(logo && x>=logoX && x<=logoX+logoW && y>=logoY && y<=logoY+logoH) dragTarget="logo";
  else dragTarget=null;
  dragging=true; startX=x; startY=y;
  if(e.touches && e.touches.length===2){
    lastDist = Math.hypot(
      e.touches[0].clientX-e.touches[1].clientX,
      e.touches[0].clientY-e.touches[1].clientY
    );
  }
}

function moveDrag(e){
  if(!dragging) return;
  const [x,y]=getPos(e);
  const dx=x-startX, dy=y-startY;
  if(e.touches && e.touches.length===2 && lastDist){
    const dist=Math.hypot(
      e.touches[0].clientX-e.touches[1].clientX,
      e.touches[0].clientY-e.touches[1].clientY
    );
    const zoom = dist/lastDist;
    if(dragTarget==="logo"){
      const cx=logoX+logoW/2, cy=logoY+logoH/2;
      logoW*=zoom; logoH*=zoom;
      if(logoW>canvas.width) logoW=canvas.width;
      if(logoH>canvas.height) logoH=canvas.height;
      logoX=cx-logoW/2; logoY=cy-logoH/2;
      if(logoX<0) logoX=0; if(logoY<0) logoY=0;
      if(logoX+logoW>canvas.width) logoX=canvas.width-logoW;
      if(logoY+logoH>canvas.height) logoY=canvas.height-logoH;
    }
    lastDist=dist;
  } else {
    if(dragTarget==="logo"){
      logoX=Math.min(Math.max(0,logoX+dx),canvas.width-logoW);
      logoY=Math.min(Math.max(0,logoY+dy),canvas.height-logoH);
    }
  }
  startX=x; startY=y;
}

function endDrag(){ dragging=false; lastDist=null; }

canvas.addEventListener("mousedown",startDrag);
canvas.addEventListener("mousemove",moveDrag);
canvas.addEventListener("mouseup",endDrag);
canvas.addEventListener("mouseleave",endDrag);
canvas.addEventListener("touchstart",startDrag);
canvas.addEventListener("touchmove",moveDrag,{passive:false});
canvas.addEventListener("touchend",endDrag);
canvas.addEventListener("touchcancel",endDrag);

// --- exportar ---
document.getElementById("exportBtn").addEventListener("click", async ()=>{
  if(!video || !logo) return alert("SubÃ­ video y logo primero.");
  if(!ffmpeg.isLoaded()) await ffmpeg.load();

  const videoFile = document.getElementById("videoInput").files[0];
  const logoFile = document.getElementById("logoInput").files[0];

  ffmpeg.FS('writeFile','input.mp4',await fetchFile(videoFile));
  ffmpeg.FS('writeFile','logo.png',await fetchFile(logoFile));

  const cmd = [
    '-i','input.mp4',
    '-i','logo.png',
    '-filter_complex',`[1:v]scale=${logoW}:${logoH}[logo];[0:v][logo]overlay=${logoX}:${logoY}`,
    '-vf','scale=1080:1350:force_original_aspect_ratio=decrease,pad=1080:1350:(ow-iw)/2:(oh-ih)/2',
    '-c:a','copy','output.mp4'
  ];

  ffmpeg.setProgress(({ratio})=>{
    document.getElementById("progressBar").value = Math.round(ratio*100);
  });

  await ffmpeg.run(...cmd);
  const data = ffmpeg.FS('readFile','output.mp4');
  const url = URL.createObjectURL(new Blob([data.buffer],{type:'video/mp4'}));
  const a = document.createElement('a'); a.href=url; a.download='video_instagram.mp4'; a.click();
});
</script>
</body>
</html>
