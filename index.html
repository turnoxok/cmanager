document.getElementById("exportBtn").addEventListener("click", async () => {
  if (!video || !logo) return alert("SubÃ­ video y logo primero.");
  const videoFile = document.getElementById("videoInput").files[0];
  const logoFile = document.getElementById("logoInput").files[0];

  const formData = new FormData();
  formData.append("video", videoFile);
  formData.append("logo", logoFile);
  formData.append("logoX", Math.round(logoX));
  formData.append("logoY", Math.round(logoY));
  formData.append("logoWidth", Math.round(logoW));
  formData.append("logoHeight", Math.round(logoH));

  // barra de progreso
  let progressBar = document.getElementById("progressBar");
  if (!progressBar) {
    progressBar = document.createElement("progress");
    progressBar.id = "progressBar";
    progressBar.max = 100;
    progressBar.value = 0;
    document.body.appendChild(progressBar);
  }

  try {
    const res = await fetch("https://imagenes-y-video-production.up.railway.app/convert", { 
      method: "POST", 
      body: formData 
    });

    if (!res.ok) throw new Error(`Server error: ${res.statusText}`);
    const { jobId } = await res.json();

    // escuchamos el progreso en tiempo real
    const evtSource = new EventSource(`https://imagenes-y-video-production.up.railway.app/progress/${jobId}`);
    evtSource.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.end) {
        progressBar.value = 100;
        evtSource.close();

        // descargar video final
        fetch("https://imagenes-y-video-production.up.railway.app/convert", { 
          method: "POST", 
          body: formData 
        }).then(r => r.blob()).then(blob => {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "video_final.mp4";
          a.click();
        });
      } else if (data.percent) {
        progressBar.value = Math.round(data.percent);
      }
    };
  } catch (err) {
    alert("Error al exportar: " + err.message);
    console.error(err);
  }
});
